<html>
<body>
<style>
  C {
     font-size: 400px;
  }

  B {
     font-size: 20px
  }
  D {
     font-size: 40px
  }
  button {
    height: 40px
  }
  input.button {
    -webkit-appearance: button;
    -moz-appearance: button;
    appearance: button;
    text-decoration: none;
    color: gray;
  }
  div.relative {
	  position: relative;
	  left: 68px;
	  width: 800px;
	  border: 3px solid #73AD21;
  }
</style>
<audio id="every10laps">
	<source src="media/Cheer.wav" type="audio/wav">
	<!--
	<source src="horse.mp3" type="audio/mpeg">
	-->
</audio>
<div hidden=true><input id="T0" value=0></div>
<div hidden=true><input id="Laps" value=0></div>
<div hidden=true><input id="Lap-Length" value=33></div>
<div class='relative'>
	<table border=0><tr><td><button onclick='start_stop();';id="B1"><B id="start_stop_action">Start</B></button></td><td><button onclick='reset();';id="B2"><B id="reset_action">Reset</B></button></td><td><button onclick="gone();"><B>Exit</B></button></td></tr>
<tr><td colspan=4><C id="_COUNTER_">0000</C></td></tr>
<tr><td><D>Distance:</D></td><td><D id="Distance">0</D></td></tr>
<tr><td><D>Time:</D></td><td><D id="Time">0</D></td></tr>
<tr><td><D>Pace:</D></td><td><D id="Pace">0</D></td><td></tr>
</table>
</div>
<script>
            var isMobile = {
    		Android: function() {
        		return navigator.userAgent.match(/Android/i);
    		},
    		BlackBerry: function() {
        		return navigator.userAgent.match(/BlackBerry/i);
    		},
    		iOS: function() {
        		return navigator.userAgent.match(/iPhone|iPad|iPod/i);
    		},
    		Opera: function() {
        		return navigator.userAgent.match(/Opera Mini/i);
    		},
    		Windows: function() {
        		return navigator.userAgent.match(/IEMobile/i) || navigator.userAgent.match(/WPDesktop/i);
    		},
    		any: function() {
        		return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
    		}
	    };
            var counterText = document.getElementById('_COUNTER_');
            var start_txt = document.getElementById('start_stop_action');
            var rest_txt = document.getElementById('reset_action');
            var start_btn = document.getElementById('B1');
            var rest_btn = document.getElementById('B2');
            if (isMobile.any()) {
		counterText.style.fontSize = "400px";
		start_txt.style.fontSize = "20px";
		rest_txt.style.fontSize = "20px"
		//start_btn.style.height = "800px";
		//reset_btn.style.height = "800px";
            }
            console.log("Creating websocket ...");
            var ws = new WebSocket("ws://192.168.1.11:5678/");
	    function compute_pace() {
                var T0 = document.getElementById('T0');
                var Laps = document.getElementById('Laps');
                var dist_box = document.getElementById('Distance');
                var time_box = document.getElementById('Time');
                var pace_box = document.getElementById('Pace');
                var lap_len_box = document.getElementById('Lap-Length');
		var now = new Date();
		var T = now.getTime()/1000;
		lap_len = parseInt(lap_len_box.value);
		laps = parseInt(Laps.value);
		elapsed  = T - Number(T0.value);
		h = Math.round(elapsed/3600);
		m = Math.round((elapsed%3600)/60);;
		s = elapsed%60;
		s = s.toFixed(1);
		time_str = h+" hours "+m+" minutes "+s + " seconds";
		time_box.innerHTML = time_str;
		distance = (laps*lap_len)/1609.0;
		distance = distance.toFixed(3)
		dist_box.innerHTML = distance + " miles";
		pace = Math.round(elapsed/distance);
		pace = pace.toFixed(3)
		pace_m = pace/60.0;
		pace_m = pace_m.toFixed(0)
		pace_s = pace%60;
		pace_s = pace_s.toFixed(1)
		pace_str = pace_m+":"+pace_s;
		pace_box.innerHTML = pace_str + " per mile";
            }
            function start_stop() {
		if (start_txt.innerHTML == "Start") {
			start_txt.innerHTML = "Stop&nbsp;";
			start_txt.color = "red";
			act = "start";
		        now = new Date();
		        T = now.getTime()/1000;
			if (T0.value==0) {
				T0.value = T.toString();
			}
		} else {
			if (Laps.value>0) {
	                    compute_pace();
			}

			start_txt.innerHTML = "Start";
			act = "stop";
		}
                if(ws)ws.send(act);
	    }
            function reset() {
		if(ws)ws.send('reset');
	    }
            function gone() {
		if(ws) {
		     ws.send('exit');
		     ws.close();
		     ws = null;
		}
	    }
            ws.onmessage = function (event) {
		if (event.data.indexOf("lap-length=")>=0) {
                    var lap_len_box = document.getElementById('Lap-Length');
		    lap_len_box.value = event.data.substring(11);
		    return;
		}
		var laps = parseInt(event.data);
		Laps.value = laps;
		if (laps < 10) {
		      txt = "000"+event.data;
		} else if(laps < 100) {
		      txt = "00"+event.data;
		} else if(laps < 1000) {
		      txt = "0"+event.data;
		} else {
		      txt = event.data;
		}
		if (laps >0 && laps % 10 == 0) {
			if (!played) {
			    //var sound = document.getElementById("every10laps");
			    //sound.play();
			    counterText.style.color = "red";
	                    compute_pace();
			    played = true;
			}
		} else {
			played = false;
			counterText.style.color = "black";
		}
                counterText.innerText = txt;

            };
</script>

</body>
</html>
